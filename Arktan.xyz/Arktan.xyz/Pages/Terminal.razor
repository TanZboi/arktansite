@page "/"
@inject IJSRuntime JSRuntime
<div class="terminal">
    <div class="output">
        @foreach (var line in outputLines.AsEnumerable())
        {
            <p>@line</p>
        }
    </div>

    <div class="input-line">
        <span class="prompt">$ </span>
        <input @bind="currentInput" @bind:event="oninput" @onkeydown="HandleKeyDown" class="input" />
        <span class="cursor">â–ˆ</span>
    </div>
</div>

@code {
    private bool isTyping = false;
    private string typingBuffer = "";
    private int typingIndex = 0;
    private string lastCommand = "";
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initShader");
        }
    }
    
    private List<string> outputLines = new();
    private string currentInput = "";

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ProcessCommand(currentInput);
            currentInput = "";
        }
    }
    
    private ElementReference outputDiv;

    private async Task ScrollToBottom()
    {
        await JSRuntime.InvokeVoidAsync("scrollToBottom", outputDiv); // Scroll to the bottom of the output
    }

    private async Task ProcessCommand(string command)
    {
        if (isTyping) return;

        lastCommand = "$ " + command;
        outputLines.Add(lastCommand);
        StateHasChanged();

        // ðŸŸ¢ Try-catch in case JSInterop fails
        try 
        {
            await JSRuntime.InvokeVoidAsync("triggerPulse");
        }
        catch (Exception ex)
        {
            outputLines.Add("[Error triggering shader pulse: " + ex.Message + "]");
        }

        isTyping = true;
        List<string> responseLines = GetResponse(command);

        foreach (var line in responseLines)
        {
            typingBuffer = line;
            typingIndex = 0;

            outputLines.Add(""); 
            int currentIndex = outputLines.Count - 1;

            await TypeOutText(currentIndex);
        }

        isTyping = false;
    }



    private async Task TypeOutText(int index)
    {
        string currentText = "";
        while (typingIndex < typingBuffer.Length)
        {
            currentText += typingBuffer[typingIndex]; // Add next letter
            outputLines[index] = currentText; // Update the correct line in outputLines
            StateHasChanged();

            await Task.Delay(15); // Adjust speed here (50ms per letter)
            typingIndex++;
        }
    }

    
    private List<string> GetResponse(string command)
    {
        return command switch
        {
            "contact" => new List<string>
            {
                "Email: bill@arktan.xyz",
                "Discord: Arktanz",
                "bluesky: @natkraart.bsky.social",
                "deviantart: @natkra",
                "Fa: natkra",
                "reddit: u/thatmako",
                "youtube: Arktan",
                "soundcloud: Arktan",
                "github: TanZboi",
                "website: arktan.xyz"
            },
            "help" => new List<string>
            {
                "Available commands:",
                "contact - Show contact information",
                "art - view art",
                "music - redirect to my music",
                "about - Show information about me",
                "clear - Clear the terminal",
                "background - Change the background shader",
                "help - Show available commands"
            },
            _ => new List<string> { "Unknown command. Try 'help'." },
        };
    }
}
